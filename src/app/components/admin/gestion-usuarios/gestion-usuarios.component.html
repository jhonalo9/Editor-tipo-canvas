<div class="gestion-usuarios-container">
  <app-vertical-header></app-vertical-header>

  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <h1>Gesti√≥n de Usuarios</h1>
      <p class="subtitle">Administra los usuarios del sistema</p>
    </div>

    <!-- Estad√≠sticas -->
    <div class="stats-grid" *ngIf="estadisticas">
      <div class="stat-card">
        <div class="stat-number">{{estadisticas.totalUsuarios || 0}}</div>
        <div class="stat-label">Total Usuarios</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{estadisticas.usuariosPremium || 0}}</div>
        <div class="stat-label">Usuarios Premium</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{estadisticas.usuariosFree || 0}}</div>
        <div class="stat-label">Usuarios Free</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{estadisticas.usuariosAdmin || 0}}</div>
        <div class="stat-label">Administradores</div>
      </div>
    </div>

    <!-- Barra de b√∫squeda y controles -->
    <div class="controls-bar">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (keyup.enter)="buscarUsuarios()"
          placeholder="Buscar usuarios por nombre..."
          class="search-input"
        />
        <button (click)="buscarUsuarios()" class="btn btn-primary">
          <i class="search-icon">üîç</i> Buscar
        </button>
        <button (click)="limpiarBusqueda()" class="btn btn-secondary">
          Limpiar
        </button>
      </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="table-container">
      <div class="table-responsive">
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Plan</th>
              <th>Rol</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="loading">
              <td colspan="6" class="loading-cell">
                <div class="loading-spinner">Cargando usuarios...</div>
              </td>
            </tr>
            <tr *ngFor="let usuario of usuariosPaginados; trackBy: trackByUserId" class="user-row">
              <td>{{usuario.id}}</td>
              <td class="user-name">{{usuario.nombre}}</td>
              <td class="user-email">{{usuario.email}}</td>
              <td>
                <span [class]="getBadgeClass(usuario.plan)" class="badge">
                  {{usuario.plan}}
                </span>
              </td>
              <td>
                <span [class]="getRolBadgeClass(usuario.rol)" class="badge">
                  {{usuario.rol}}
                </span>
              </td>
              <td class="actions-cell">
                <div class="action-buttons">
                  <button 
                    (click)="abrirEditarUsuario(usuario)" 
                    class="btn btn-sm btn-outline"
                    title="Editar usuario"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button 
                    (click)="abrirCambioPlan(usuario)" 
                    class="btn btn-sm btn-outline"
                    title="Cambiar plan"
                  >
                    üíé
                  </button>
                  <button 
                    (click)="abrirCambioRol(usuario)" 
                    class="btn btn-sm btn-outline"
                    title="Cambiar rol"
                  >
                    üë§
                  </button>
                  <button 
                    *ngIf="usuario.plan === 'FREE'"
                    (click)="upgradeAPremium(usuario)" 
                    class="btn btn-sm btn-success"
                    title="Upgrade a Premium"
                  >
                    ‚¨ÜÔ∏è
                  </button>
                  <button 
                    *ngIf="usuario.plan === 'PREMIUM'"
                    (click)="downgradeAFree(usuario)" 
                    class="btn btn-sm btn-warning"
                    title="Downgrade a Free"
                  >
                    ‚¨áÔ∏è
                  </button>
                  <button 
                    (click)="abrirConfirmarEliminacion(usuario)" 
                    class="btn btn-sm btn-danger"
                    title="Eliminar usuario"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="!loading && usuarios.length === 0">
              <td colspan="6" class="no-data">
                No se encontraron usuarios
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginaci√≥n -->
      <div class="pagination" *ngIf="totalPages > 1">
        <button 
          (click)="cambiarPagina(currentPage - 1)" 
          [disabled]="currentPage === 1"
          class="btn btn-outline"
        >
          Anterior
        </button>
        
        <span class="page-info">
          P√°gina {{currentPage}} de {{totalPages}}
        </span>
        
        <button 
          (click)="cambiarPagina(currentPage + 1)" 
          [disabled]="currentPage === totalPages"
          class="btn btn-outline"
        >
          Siguiente
        </button>
      </div>
    </div>
  </div> <!-- Cierre del main-content -->

  <!-- MODALES FUERA DEL MAIN-CONTENT -->

  <!-- Modal Editar Usuario -->
  <div *ngIf="showEditModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Editar Usuario: {{selectedUsuario?.nombre}}</h3>
        <button (click)="cerrarModales()" class="close-btn">√ó</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editUsuarioForm">
          <div class="form-group">
            <label>Nombre:</label>
            <input type="text" formControlName="nombre" class="form-control">
          </div>
          <div class="form-group">
            <label>Email:</label>
            <input type="email" formControlName="email" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button (click)="cerrarModales()" class="btn btn-secondary">Cancelar</button>
        <button 
          (click)="guardarEdicionUsuario()" 
          [disabled]="!editUsuarioForm.valid || loading"
          class="btn btn-primary"
        >
          {{loading ? 'Guardando...' : 'Guardar Cambios'}}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Cambiar Plan -->
  <div *ngIf="showPlanModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Cambiar Plan: {{selectedUsuario?.nombre}}</h3>
        <button (click)="cerrarModales()" class="close-btn">√ó</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="cambioPlanForm">
          <div class="form-group">
            <label>Seleccionar Plan:</label>
            <select formControlName="plan" class="form-control">
              <option value="FREE">Free</option>
              <option value="PREMIUM">Premium</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button (click)="cerrarModales()" class="btn btn-secondary">Cancelar</button>
        <button 
          (click)="cambiarPlan()" 
          [disabled]="!cambioPlanForm.valid || loading"
          class="btn btn-primary"
        >
          {{loading ? 'Actualizando...' : 'Cambiar Plan'}}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Cambiar Rol -->
  <div *ngIf="showRolModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Cambiar Rol: {{selectedUsuario?.nombre}}</h3>
        <button (click)="cerrarModales()" class="close-btn">√ó</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="cambioRolForm">
          <div class="form-group">
            <label>Seleccionar Rol:</label>
            <select formControlName="rol" class="form-control">
              <option value="USER">Usuario</option>
              <option value="ADMIN">Administrador</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button (click)="cerrarModales()" class="btn btn-secondary">Cancelar</button>
        <button 
          (click)="cambiarRol()" 
          [disabled]="!cambioRolForm.valid || loading"
          class="btn btn-primary"
        >
          {{loading ? 'Actualizando...' : 'Cambiar Rol'}}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Confirmar Eliminaci√≥n -->
  <div *ngIf="showDeleteConfirm" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Confirmar Eliminaci√≥n</h3>
        <button (click)="cerrarModales()" class="close-btn">√ó</button>
      </div>
      <div class="modal-body">
        <p>¬øEst√°s seguro de que quieres eliminar al usuario <strong>{{selectedUsuario?.nombre}}</strong>?</p>
        <p class="warning-text">Esta acci√≥n no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button (click)="cerrarModales()" class="btn btn-secondary">Cancelar</button>
        <button 
          (click)="eliminarUsuario()" 
          [disabled]="loading"
          class="btn btn-danger"
        >
          {{loading ? 'Eliminando...' : 'Eliminar Usuario'}}
        </button>
      </div>
    </div>
  </div>
</div>
<app-header></app-header>
<div class="template-list-container">
 
  <!-- Header -->
  <div class="header">
    <h1>
      Design Plantillas
    </h1>
    <p class="text-muted">Administra y edita tus plantillas de líneas de tiempo</p>
  </div>

  <!-- Controles -->
  <div class="controls-card">
    <div class="row align-items-center">
      <div class="col-md-4">
        <!-- Buscador -->
        <div class="input-group">
          <span class="input-group-text">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" 
                 class="form-control" 
                 placeholder="Buscar plantillas..." 
                 [(ngModel)]="filtro"
                 (input)="filtro = $any($event.target).value">
        </div>
      </div>

      <div class="col-md-4">
        <!-- Selector de vista corregido -->
        <select class="form-select" [(ngModel)]="vista" (change)="cambiarVista(vista)">
          <option value="todos">
            <i class="fas fa-layer-group me-1"></i>
            Todos
          </option>
          <option value="publicas">
            <i class="fas fa-globe me-1"></i>
            Públicas
          </option>
          <option value="privadas">
            <i class="fas fa-lock me-1"></i>
            Privadas
          </option>
        </select>
      </div>

      <div class="col-md-4">
        <!-- Contador de plantillas corregido -->
        <h4>
          <!--{{ plantillasFiltradas.length }} de {{ numeroPlantillasVistaActual }} Plantillas-->
           Total: {{ numeroPlantillasVistaActual }}
        </h4>
      </div>
    </div>
  </div>

  <div>
    <button routerLink="/admin/design" class="btn btn-dark m-3 btn-lg">crear +</button>
  </div>

  <!-- Estado de carga -->
  <div *ngIf="cargando" class="loading-state">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Cargando plantillas...</p>
  </div>

  <!-- Lista de plantillas -->
  <div *ngIf="!cargando" class="plantillas-grid">
    <!-- Mensaje si no hay plantillas -->
    <div *ngIf="plantillasFiltradas.length === 0" class="empty-state">
      <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
      <h4>No hay plantillas</h4>
      <p class="text-muted">
        {{ filtro ? 'No se encontraron plantillas que coincidan con tu búsqueda.' : 
            vista === 'todos' ? 'No tienes plantillas creadas.' : 
            vista === 'publicas' ? 'No hay plantillas públicas disponibles.' :
            'No hay plantillas privadas.' }}
      </p>
      <button routerLink="/admin/design" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i>
        Crear Primera Plantilla
      </button>
    </div>

    <!-- Grid de plantillas -->
    <div class="row">
      <div *ngFor="let plantilla of plantillasFiltradas" class="col-xl-4 col-lg-6 col-md-6 mb-4">
        <div class="plantilla-card">
          <!-- Thumbnail/Portada -->
          <div class="plantilla-thumbnail">
            <img [src]="getImagenPlantilla(plantilla)" 
                 [alt]="plantilla.nombre"
                 class="thumbnail-image"
                 (error)="onImageError($event)">
            
            <!-- Badges superpuestos -->
            <div class="thumbnail-badges">
              <span [class]="getClaseCategoria(plantilla.categoria)">
                <i [class]="getIconoCategoria(plantilla.categoria) + ' me-1'"></i>
                {{getNombreCategoria(plantilla.categoria)}}
              </span>
              <span *ngIf="plantilla.esPublica" class="badge bg-success">
                <i class="fas fa-globe me-1"></i>
                Pública
              </span>
              <span *ngIf="!plantilla.esPublica" class="badge bg-secondary">
                <i class="fas fa-lock me-1"></i>
                Privada
              </span>
            </div>
          </div>

          <!-- Contenido de la tarjeta -->
          <div class="plantilla-content">
            <h5 class="plantilla-title">{{plantilla.nombre}}</h5>
            <p class="plantilla-description">{{plantilla.descripcion || 'Sin descripción'}}</p>
            
            <div class="plantilla-meta">
              <small class="text-muted">
                <i class="fas fa-calendar me-1"></i>
                {{formatearFecha(plantilla.metadatos?.fechaModificacion || plantilla.metadatos?.fechaCreacion)}}
              </small>
              <small class="text-muted">
                <i class="fas fa-chart-bar me-1"></i>
                {{ getTextoUso(plantilla) }}
              </small>
            </div>

            <!-- Acciones -->
            <div class="plantilla-actions">
              <button class="btn btn-outline-primary btn-sm" 
                      (click)="editarPlantilla(plantilla)"
                      title="Editar plantilla">
                <i class="fas fa-edit"></i>
              </button>
              
              <button class="btn btn-outline-success btn-sm" 
                      (click)="duplicarPlantilla(plantilla)"
                      title="Duplicar plantilla">
                <i class="fas fa-copy"></i>
              </button>
              
              <button class="btn btn-outline-warning btn-sm" 
                      (click)="cambiarVisibilidad(plantilla)"
                      [title]="plantilla.esPublica ? 'Hacer privada' : 'Hacer pública'">
                <i [class]="plantilla.esPublica ? 'fas fa-lock' : 'fas fa-globe'"></i>
              </button>
              
              <button class="btn btn-outline-info btn-sm" 
                      (click)="verDetalles(plantilla)"
                      title="Ver detalles">
                <i class="fas fa-info-circle"></i>
              </button>
              
              <button class="btn btn-outline-danger btn-sm" 
                      (click)="eliminarPlantilla(plantilla)"
                      title="Eliminar plantilla">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de detalles (se mantiene igual) -->
  <div *ngIf="plantillaSeleccionada" class="modal-overlay" (click)="cerrarDetalles()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">
          <i [class]="getIconoCategoria(plantillaSeleccionada.categoria) + ' me-2'"></i>
          {{plantillaSeleccionada.nombre}}
        </h5>
        <button type="button" class="btn-close" (click)="cerrarDetalles()"></button>
      </div>
      
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <img [src]="getImagenPlantilla(plantillaSeleccionada)" 
                 [alt]="plantillaSeleccionada.nombre"
                 class="img-fluid rounded">
          </div>
          
          <div class="col-md-6">
            <h6>Descripción</h6>
            <p>{{plantillaSeleccionada.descripcion || 'Sin descripción'}}</p>
            
            <h6>Información</h6>
            <ul class="list-unstyled">
              <li>
                <strong>Categoría:</strong> 
                <span [class]="getClaseCategoria(plantillaSeleccionada.categoria) + ' ms-2'">
                  {{getNombreCategoria(plantillaSeleccionada.categoria)}}
                </span>
              </li>
              <li>
                <strong>Estado:</strong> 
                <span [class]="plantillaSeleccionada.esPublica ? 'text-success' : 'text-secondary'">
                  {{plantillaSeleccionada.esPublica ? 'Pública' : 'Privada'}}
                </span>
              </li>
              <li>
                <strong>Creada:</strong> 
                {{formatearFecha(plantillaSeleccionada.metadatos.fechaCreacion)}}
              </li>
              <li>
                <strong>Modificada:</strong> 
                {{formatearFecha(plantillaSeleccionada.metadatos.fechaModificacion)}}
              </li>
              <li>
                <strong>Veces usada:</strong> 
                {{ getVecesUsada(plantillaSeleccionada) }}
              </li>
              <li *ngIf="plantillaSeleccionada.configuracionVisual?.canvasWidth">
                <strong>Dimensiones:</strong> 
                {{plantillaSeleccionada.configuracionVisual.canvasWidth}}x{{plantillaSeleccionada.configuracionVisual.canvasHeight}}
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarDetalles()">
          Cerrar
        </button>
        <button type="button" class="btn btn-primary" (click)="editarPlantilla(plantillaSeleccionada)">
          <i class="fas fa-edit me-1"></i>
          Editar Plantilla
        </button>
      </div>
    </div>
  </div>
</div>